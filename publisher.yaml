#!/bin/bash

# filepath: /path/to/script.sh

# Input and output file paths
INPUT_FILE="input.txt"
OUTPUT_FILE="output.txt"

# Clear the output file if it exists
> "$OUTPUT_FILE"

# Check if input file exists
if [[ ! -f "$INPUT_FILE" ]]; then
  echo "Input file $INPUT_FILE not found!"
  exit 1
fi

# OpenShift login credentials
USERNAME="kurelak"
PASSWORD="R@nch0@123"

# Loop through each cluster name in the input file
while IFS= read -r CLUSTER_NAME; do
  if [[ -z "$CLUSTER_NAME" ]]; then
    continue
  fi

  echo "Processing cluster: $CLUSTER_NAME"

  # Log into the cluster
  oc login "https://api.${CLUSTER_NAME}.ebiz.verizon.com" -u "$USERNAME" -p "$PASSWORD" --insecure-skip-tls-verify 2>/dev/null
  if [[ $? -ne 0 ]]; then
    echo "Failed to log into cluster: $CLUSTER_NAME" >> "$OUTPUT_FILE"
    continue
  fi

  # Get all namespaces
  NAMESPACES=$(oc get namespaces -o jsonpath='{.items[*].metadata.name}')
  if [[ $? -ne 0 ]]; then
    echo "Failed to fetch namespaces for cluster: $CLUSTER_NAME" >> "$OUTPUT_FILE"
    continue
  fi

  # Write cluster name to the output file
  echo "Cluster: $CLUSTER_NAME" >> "$OUTPUT_FILE"

  # Loop through each namespace and check specific labels and annotation
  for NAMESPACE in $NAMESPACES; do
    echo "  Namespace: $NAMESPACE" >> "$OUTPUT_FILE"

    # Get specific labels
    LOB_LABEL=$(oc get namespace "$NAMESPACE" -o jsonpath='{.metadata.labels.onboarding\.xyz\.io/lob}' 2>/dev/null)
    VAST_LABEL=$(oc get namespace "$NAMESPACE" -o jsonpath='{.metadata.labels.onboarding\.xyz\.io/vast}' 2>/dev/null)

    # Get specific annotation
    SUPPORT_POC_ANNOTATION=$(oc get namespace "$NAMESPACE" -o jsonpath='{.metadata.annotations.xyz\.com/support-poc}' 2>/dev/null)

    # Check and write labels and annotation to the output file
    if [[ -z "$LOB_LABEL" ]]; then
      echo "    Label - onboarding.xyz.io/lob: Not Found" >> "$OUTPUT_FILE"
    else
      echo "    Label - onboarding.xyz.io/lob: $LOB_LABEL" >> "$OUTPUT_FILE"
    fi

    if [[ -z "$VAST_LABEL" ]]; then
      echo "    Label - onboarding.xyz.io/vast: Not Found" >> "$OUTPUT_FILE"
    else
      echo "    Label - onboarding.xyz.io/vast: $VAST_LABEL" >> "$OUTPUT_FILE"
    fi

    if [[ -z "$SUPPORT_POC_ANNOTATION" ]]; then
      echo "    Annotation - xyz.com/support-poc: Not Found" >> "$OUTPUT_FILE"
    else
      echo "    Annotation - xyz.com/support-poc: $SUPPORT_POC_ANNOTATION" >> "$OUTPUT_FILE"
    fi
  done

  echo "" >> "$OUTPUT_FILE" # Add a blank line for readability
done < "$INPUT_FILE"

echo "Processing complete. Output written to $OUTPUT_FILE."
